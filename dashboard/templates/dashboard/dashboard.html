{% extends 'base/base.html' %}
{% load static %}
{% load tz %}

{% block page_title %}
Dashboard
{% endblock page_title %}

{% block stylesheets %}
<link rel="stylesheet" href="{% static 'base//styles//filters_card.css' %}">
<link rel="stylesheet" href="{% static 'dashboard//styles//dashboard.css' %}">
{% endblock stylesheets %}

{% block content %}
<!-- Dashboard Section -->
<section id="dashboard-stats">
    <div id="stats-header">
        <h2>Dashboard</h2>
        <p>Account stats</p>
    </div>

    <div id="stats-cards">
        <div class="stat-card floating-card">
            <div class="stat-card-header">
                <h3>
                    Stores
                    
                    <svg height="24" viewBox="0 0 48 48" width="24" xmlns="http://www.w3.org/2000/svg">
                        <path fill="currentColor" d="M14 36c-2.21 0-3.98 1.79-3.98 4s1.77 4 3.98 4 4-1.79 4-4-1.79-4-4-4zm-12-32v4h4l7.19 15.17-2.7 4.9c-.31.58-.49 1.23-.49 1.93 0 2.21 1.79 4 4 4h24v-4h-23.15c-.28 0-.5-.22-.5-.5 0-.09.02-.17.06-.24l1.79-3.26h14.9c1.5 0 2.81-.83 3.5-2.06l7.15-12.98c.16-.28.25-.61.25-.96 0-1.11-.9-2-2-2h-29.57l-1.9-4h-6.53zm32 32c-2.21 0-3.98 1.79-3.98 4s1.77 4 3.98 4 4-1.79 4-4-1.79-4-4-4z"/>
                        <path d="M0 0h48v48h-48z" fill="none"/>
                    </svg>
                </h3>

                <p>Total number of stores</p>
            </div>
            <div class="stat-card-body">
                <h1>{{ stores_count }}</h1>
            </div>
        </div>

        <div class="stat-card floating-card">
            <div class="stat-card-header">
                <h3>
                    Products
                    
                    <svg height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
                        <path fill="currentColor" d="M6.5,22 C4.01471863,22 2,19.9852814 2,17.5 C2,15.0147186 4.01471863,13 6.5,13 C8.98528137,13 11,15.0147186 11,17.5 C11,19.9852814 8.98528137,22 6.5,22 Z M17.5,22 C15.0147186,22 13,19.9852814 13,17.5 C13,15.0147186 15.0147186,13 17.5,13 C19.9852814,13 22,15.0147186 22,17.5 C22,19.9852814 19.9852814,22 17.5,22 Z M6.5,11 C4.01471863,11 2,8.98528137 2,6.5 C2,4.01471863 4.01471863,2 6.5,2 C8.98528137,2 11,4.01471863 11,6.5 C11,8.98528137 8.98528137,11 6.5,11 Z M17.5,11 C15.0147186,11 13,8.98528137 13,6.5 C13,4.01471863 15.0147186,2 17.5,2 C19.9852814,2 22,4.01471863 22,6.5 C22,8.98528137 19.9852814,11 17.5,11 Z M17.5,9 C18.8807119,9 20,7.88071187 20,6.5 C20,5.11928813 18.8807119,4 17.5,4 C16.1192881,4 15,5.11928813 15,6.5 C15,7.88071187 16.1192881,9 17.5,9 Z M6.5,9 C7.88071187,9 9,7.88071187 9,6.5 C9,5.11928813 7.88071187,4 6.5,4 C5.11928813,4 4,5.11928813 4,6.5 C4,7.88071187 5.11928813,9 6.5,9 Z M17.5,20 C18.8807119,20 20,18.8807119 20,17.5 C20,16.1192881 18.8807119,15 17.5,15 C16.1192881,15 15,16.1192881 15,17.5 C15,18.8807119 16.1192881,20 17.5,20 Z M6.5,20 C7.88071187,20 9,18.8807119 9,17.5 C9,16.1192881 7.88071187,15 6.5,15 C5.11928813,15 4,16.1192881 4,17.5 C4,18.8807119 5.11928813,20 6.5,20 Z"/>
                    </svg>
                </h3>

                <p>Number of products available in all stores</p>
            </div>
            <div class="stat-card-body">
                <h1>{{ products_count }}</h1>
            </div>
        </div>

        <div id="sales-card" class="stat-card floating-card">
            <div class="stat-card-header">
                <h3>
                    Sales

                    <svg height="24" viewBox="0 0 48 48" width="24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M0 0h48v48H0z" fill="none"/>
                        <path fill="currentColor" d="M8 12H4v28c0 2.21 1.79 4 4 4h28v-4H8V12zm32-8H16c-2.21 0-4 1.79-4 4v24c0 2.21 1.79 4 4 4h24c2.21 0 4-1.79 4-4V8c0-2.21-1.79-4-4-4zm-2 18H18v-4h20v4zm-8 8H18v-4h12v4zm8-16H18v-4h20v4z"/>
                    </svg>
                </h3>
                <p>Total number of sales made (Today)</p>
            </div>

            <div class="stat-card-body">
                <h1 class="stat-value">{{ sales_count_today }}</h1>

                <span class="more-options" data-title="Filter sales by">Advanced options</span>
            </div>
        </div>

        <div id="revenue-card" class="stat-card floating-card">
            <div class="stat-card-header">
                <h3>
                    Revenue
                    
                    <svg 
                        xmlns="http://www.w3.org/2000/svg" 
                        width="24" height="24" 
                        viewBox="0 0 24 24" 
                        style="fill: currentColor;"
                    >
                        <path d="M12 15c-1.84 0-2-.86-2-1H8c0 .92.66 2.55 3 2.92V18h2v-1.08c2-.34 3-1.63 3-2.92 0-1.12-.52-3-4-3-2 0-2-.63-2-1s.7-1 2-1 1.39.64 1.4 1h2A3 3 0 0 0 13 7.12V6h-2v1.09C9 7.42 8 8.71 8 10c0 1.12.52 3 4 3 2 0 2 .68 2 1s-.62 1-2 1z"></path>
                        <path d="M5 2H2v2h2v17a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1V4h2V2H5zm13 18H6V4h12z"></path>
                    </svg>
                </h3>
                <p>Total revenue (Today)</p>
            </div>

            <div class="stat-card-body">
                <h1 class="stat-value">{{ revenue_from_sales_today }}</h1>

                <span class="more-options" data-title="Filter revenue by">Advanced options</span>
            </div>
        </div>

        {% if most_sold_product %}
        <div id="most-sold-card" class="stat-card floating-card">
            <div class="stat-card-header">
                <h3>
                    Most sold product

                    <svg 
                        xmlns="http://www.w3.org/2000/svg" 
                        width="24" height="24" 
                        viewBox="0 0 24 24" 
                        style="fill: currentColor;"
                    >
                        <path d="M13 2.051V11h8.949c-.47-4.717-4.232-8.479-8.949-8.949zm4.969 17.953c2.189-1.637 3.694-4.14 3.98-7.004h-8.183l4.203 7.004z"></path>
                        <path d="M11 12V2.051C5.954 2.555 2 6.824 2 12c0 5.514 4.486 10 10 10a9.93 9.93 0 0 0 4.255-.964s-5.253-8.915-5.254-9.031A.02.02 0 0 0 11 12z"></path>
                    </svg>
                </h3>
                
                <p class="stat-value-misc">{{ most_sold_product.store.name }} - {{ most_sold_product.total_quantity_sold }} units sold</p>
            </div>

            <div class="stat-card-body">
                <h1 class="stat-value">{{ most_sold_product.name }}</h1>

                <!-- Most Sold Product Form Section -->
                <form action="{% url 'dashboard:most_sold_product_stat' %}" id="most-sold-product-form">
                    {% csrf_token %}
                    <div class="form-fields">
                        <div class="form-field">
                            <label for="timeframe" hidden>Time frame</label>
                            <select 
                                title="Select a time frame"
                                id="timeframe" 
                                name="timeframe" 
                                required 
                                placeholder="Select a time frame"
                                class="form-select"
                            >   
                                <option value="all time" selected>All time</option>
                                <option value="past 3 days">In the past 3 days</option>
                                <option value="past week">In the past week</option>
                                <option value="past 2 weeks">In the past 2 weeks</option>
                                <option value="past month">In the past month</option>
                                <option value="past 3 months">In the past 3 month</option>
                                <option value="past 6 months">In the past 6 month</option>
                                <option value="past year">In the past year</option>
                            </select>
                            <small class="field-message"></small>
                        </div> 
                    </div>
                </form>
            </div>
        </div>
        {% endif %}

        {% if most_active_store %}
        <div id="revenue-card" class="stat-card floating-card">
            <div class="stat-card-header">
                <h3>
                    Most active store

                    <svg 
                        xmlns="http://www.w3.org/2000/svg" 
                        width="24" height="24" 
                        viewBox="0 0 24 24" 
                        style="fill: currentColor;"
                    >
                        <path d="M3 3v17a1 1 0 0 0 1 1h17v-2H5V3H3z"></path>
                        <path d="M15.293 14.707a.999.999 0 0 0 1.414 0l5-5-1.414-1.414L16 12.586l-2.293-2.293a.999.999 0 0 0-1.414 0l-5 5 1.414 1.414L13 12.414l2.293 2.293z"></path>
                    </svg>
                </h3>

                <p class="stat-value-misc">{{ most_active_store.sales_count }} sales made</p>
            </div>

            <div class="stat-card-body">
                <h1 class="stat-value">{{ most_active_store.name }}</h1>

                <!-- Most Active Sroduct Form Section -->
                <form action="{% url 'dashboard:most_active_store_stat' %}" id="most-active-store-form">
                    {% csrf_token %}
                    <div class="form-fields">
                        <div class="form-field">
                            <label for="timeframe" hidden>Time frame</label>
                            <select 
                                title="Select a time frame"
                                id="timeframe" 
                                name="timeframe" 
                                required 
                                placeholder="Select a time frame"
                                class="form-select"
                            >   
                                <option value="all time" selected>All time</option>
                                <option value="past 3 days">In the past 3 days</option>
                                <option value="past week">In the past week</option>
                                <option value="past 2 weeks">In the past 2 weeks</option>
                                <option value="past month">In the past month</option>
                                <option value="past 3 months">In the past 3 month</option>
                                <option value="past 6 months">In the past 6 month</option>
                                <option value="past year">In the past year</option>
                            </select>
                            <small class="field-message"></small>
                        </div> 
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
    </div>


    <div class="floating-card filters-card">
        <div class="card-header">
            <h4>
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width="24" height="24" 
                    viewBox="0 0 24 24" 
                    style="fill: currentColor;"
                >
                    <path d="M7 11h10v2H7zM4 7h16v2H4zm6 8h4v2h-4z"></path>
                </svg>

                Filters
            </h4>

            <img class="close-card" width="16" height="16" src="{% static 'icons/close-icon.svg' %}">
        </div>

        <div class="card-body">
            <div class="card-body-head">
                <h3 class="card-title"></h3>
                <button class="apply-btn btn-secondary">Apply</button>
            </div>

            <form id="filter-form">
                {% csrf_token %}
                <fieldset class="store-filters" data-name="store_pks">
                    <legend>Store</legend>

                    {% for store in request.user.stores.all %}
                    <div class="form-field">
                        <input type="checkbox" name="{{ store.pk }}" id="{{ store.pk }}" value="{{ store.pk }}" checked>
                        <label for="{{ store.pk }}">{{ store.name }}</label>
                    </div>
                    {% endfor %}
                </fieldset>

                <fieldset class="category-filters" data-name="categories">
                    <legend>Product Category</legend>

                    {% for category in product_categories %}
                    <div class="form-field">
                        <input type="checkbox" name="{{ category }}" id="{{ category }}" value="{{ category }}">
                        <label for="{{ category }}">{{ category }}</label>
                    </div>
                    {% endfor %}
                </fieldset>

                <fieldset class="date-filter" data-name="date">
                    <legend>Date</legend>

                    <div class="form-field">
                        <input type="date" name="date" id="date" max="{% now 'Y-m-d' %}">
                    </div>
                </fieldset>

                <fieldset class="time-range-filter" data-name="time-range">
                    <legend>Time Range</legend>

                    <div class="form-field">
                        <label for="from-time">From</label>
                        <input type="time" name="from-time" id="from-time" value="00:00">
                    </div>

                    <div class="form-field">
                        <label for="to-time">To</label>
                        <input type="time" name="to-time" id="to-time" value="23:59">
                    </div>
                </fieldset>

                <fieldset class="date-range-filter" data-name="date-range">
                    <legend>Date Range</legend>

                    <div class="form-field">
                        <label for="from-date">From</label>
                        <input type="date" name="from-date" id="from-date" value="" max="{% now 'Y-m-d' %}">
                    </div>

                    <div class="form-field">
                        <label for="to-date">To</label>
                        <input type="date" name="to-date" id="to-date" value="" max="{% now 'Y-m-d' %}">
                    </div>
                </fieldset>
            </form>
        </div>
    </div>

</section>

<!-- Charts and Graphs Section -->

{% endblock content %}

{% block scripts %}
<script src="{% static 'base//scripts//filtersCard.js' %}"></script>
<script src="{% static 'dashboard//scripts//salesRevenueStats.js' %}"></script>
<script src="{% static 'dashboard//scripts//mostSoldProductStat.js' %}"></script>
<script src="{% static 'dashboard//scripts//mostActiveStoreStat.js' %}"></script>
{% endblock scripts %}

